name: üõ°Ô∏è Hardcore Ansible CI (Fedora Latest)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Security & Secret Scanning (‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏£‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏ï‡πà‡∏≠)
  # ------------------------------------------------------------------
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Secret/Password ‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤‡πÑ‡∏´‡∏°
      - name: üê∑ TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      # 2. ‡πÄ‡∏ä‡πá‡∏Ñ Best Practices ‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á Code
      - name: üõ°Ô∏è KICS IaC Security
        uses: checkmarx/kics-github-action@v1.7.0
        with:
          path: "."
          output_path: "kics-results"
          ignore_on_exit: results # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ó‡∏≥ Fail (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'all' ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ Fail)

  # ------------------------------------------------------------------
  # JOB 2: Validation & Linting (‡πÄ‡∏ä‡πá‡∏Ñ Syntax ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô)
  # ------------------------------------------------------------------
  validate:
    name: üîç Strict Validation
    runs-on: ubuntu-latest
    needs: [security-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: pip install ansible-core ansible-lint yamllint

      - name: üßπ Ansible Lint (Strict Mode)
        run: |
          # ‡πÉ‡∏ä‡πâ Profile 'production' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
          ansible-lint --profile production --strict playbook.yaml roles/

  # ------------------------------------------------------------------
  # JOB 3: Real Execution & Idempotence (Fedora Latest Only)
  # ------------------------------------------------------------------
  test-fedora:
    name: üöÄ Test on Fedora Latest
    runs-on: ubuntu-latest
    needs: [validate]
    container:
      image: fedora:latest # üéØ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      options: --privileged # ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Install CI Dependencies
        run: |
          dnf install -y --allowerasing python3 python3-pip git
          pip3 install ansible-core

      - name: Install Collections
        run: ansible-galaxy collection install community.general

      - name: üìù Create Local Inventory
        run: |
          echo "[local]" > inventory.ini
          echo "localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3" >> inventory.ini

      # --- ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏£‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á ---
      - name: ‚ñ∂Ô∏è First Run (Execution)
        run: |
          echo "=== FIRST RUN STARTED ==="
          ansible-playbook playbook.yaml -i inventory.ini
        env:
          ANSIBLE_FORCE_COLOR: '1'

      # --- ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á (Idempotence) ---
      # ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (changed=0)
      - name: üîÑ Idempotence Check (The Hardcore Part)
        run: |
          echo "=== IDEMPOTENCE CHECK STARTED ==="
          
          # ‡∏£‡∏±‡∏ô Playbook ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö Output ‡πÑ‡∏ß‡πâ
          OUTPUT=$(ansible-playbook playbook.yaml -i inventory.ini)
          echo "$OUTPUT"
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ changed=0 ‡πÅ‡∏•‡∏∞ failed=0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if echo "$OUTPUT" | grep -q 'changed=0.*failed=0'; then
            echo "‚úÖ IDEMPOTENCE PASSED: System is stable."
          else
            echo "‚ùå IDEMPOTENCE FAILED: Changes detected on second run!"
            exit 1
          fi
        env:
          ANSIBLE_FORCE_COLOR: '1'

  # ------------------------------------------------------------------
  # JOB 4: Final Report (‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•)
  # ------------------------------------------------------------------
  report:
    name: üìä Final Report
    runs-on: ubuntu-latest
    if: always()
    needs: [test-fedora]
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.test-fedora.result }}" == "success" ]]; then
             echo "‚úÖ PASSED: Fedora Latest is ready for production!"
          else
             echo "‚ùå FAILED: Something went wrong."
             exit 1
          fi