name: Ansible CI Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:
jobs:
    # ------------------------------------------------------------------
    # JOB 1: Security & Secret Scanning
    # ------------------------------------------------------------------
    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Secret detection
            - name: TruffleHog OSS
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --debug --only-verified

            # Infrastructure as Code Security
            - name: KICS IaC Security
              uses: checkmarx/kics-github-action@v1.7.0
              with:
                  path: "."
                  output_path: "kics-results"
                  ignore_on_exit: results

    # ------------------------------------------------------------------
    # JOB 2: Validation & Linting
    # ------------------------------------------------------------------
    validate:
        name: Strict Validation
        runs-on: ubuntu-latest
        needs: [security-scan]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: Install Dependencies
              run: pip install ansible-core ansible-lint yamllint

            - name: Ansible Lint (Strict Mode)
              run: |
                  ansible-lint --profile production --strict playbook.yaml roles/

    # ------------------------------------------------------------------
    # JOB 3: Real Execution & Idempotence
    # ------------------------------------------------------------------
    test-fedora:
        name: Test on Fedora Latest
        runs-on: ubuntu-latest
        needs: [validate]
        container:
            image: fedora:latest
            options: --privileged
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install CI Dependencies
              run: |
                  dnf install -y --allowerasing python3 python3-pip git
                  pip3 install ansible-core

            - name: Install Collections
              run: ansible-galaxy collection install -r requirements.yml

            - name: Create Local Inventory
              run: |
                  echo "[local]" > inventory.ini
                  echo "localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3" >> inventory.ini

            # Run 1: First execution
            - name: First Run (Execution)
              run: |
                  echo "=== FIRST RUN STARTED ==="
                  # Disable RPM Fusion in CI (network restricted in GitHub Actions containers)
                  ansible-playbook playbook.yaml -i inventory.ini \
                    -e "common_enable_rpm_fusion=false" \
                    -e "common_install_nvidia_drivers=false" \
                    -e "common_configure_custom_dns=false" \
                    -e "common_install_d2=false"
              env:
                  ANSIBLE_FORCE_COLOR: "1"
                  CI: "true"

            # Run 2: Idempotence check
            - name: Idempotence Check
              run: |
                  echo "=== IDEMPOTENCE CHECK STARTED ==="

                  OUTPUT=$(ansible-playbook playbook.yaml -i inventory.ini \
                    -e "common_enable_rpm_fusion=false" \
                    -e "common_install_nvidia_drivers=false" \
                    -e "common_configure_custom_dns=false" \
                    -e "common_install_d2=false")
                  echo "$OUTPUT"

                  # Check for idempotence: changed should be 0 and failed should be 0
                  # More robust pattern matching that works regardless of line breaks
                  CHANGED_COUNT=$(echo "$OUTPUT" | grep -oP 'changed=\K\d+' || echo "0")
                  FAILED_COUNT=$(echo "$OUTPUT" | grep -oP 'failed=\K\d+' || echo "0")

                  # Use the last occurrence (from the final recap)
                  CHANGED_COUNT=$(echo "$CHANGED_COUNT" | tail -n1)
                  FAILED_COUNT=$(echo "$FAILED_COUNT" | tail -n1)

                  echo "Idempotence Check Results: changed=$CHANGED_COUNT, failed=$FAILED_COUNT"

                  if [ "$CHANGED_COUNT" = "0" ] && [ "$FAILED_COUNT" = "0" ]; then
                    echo "PASSED: System is stable."
                  else
                    echo "FAILED: Changes or failures detected on second run!"
                    echo "  - Changed count: $CHANGED_COUNT (should be 0)"
                    echo "  - Failed count: $FAILED_COUNT (should be 0)"
                    exit 1
                  fi
              env:
                  ANSIBLE_FORCE_COLOR: "1"
                  CI: "true"

    # ------------------------------------------------------------------
    # JOB 4: Final Report
    # ------------------------------------------------------------------
    report:
        name: Final Report
        runs-on: ubuntu-latest
        if: always()
        needs: [test-fedora]
        steps:
            - name: Check Status
              run: |-
                  if [[ "${{ needs.test-fedora.result }}" == "success" ]]; then
                     echo "PASSED: Fedora Latest is ready for production!"
                  else
                     echo "FAILED: Something went wrong."
                     exit 1
                  fi
