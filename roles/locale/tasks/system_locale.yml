---
# SPDX-License-Identifier: MIT-0
# =============================================================================
# System Locale Configuration
# =============================================================================
# STATE: System locale must be configured to English (en_US.UTF-8)
# This ensures all system-level output is in English for debugging consistency.
# =============================================================================

- name: "STATE: System locale configuration file must exist"
  ansible.builtin.copy:
    dest: /etc/locale.conf
    content: |
      LANG="{{ locale_lang }}"
      LC_COLLATE="{{ locale_lc_collate }}"
      {% if locale_lc_all %}
      LC_ALL="{{ locale_lc_all }}"
      {% endif %}
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: locale_system_locale_config
  notify: Regenerate locales

- name: "STATE: System environment file must enforce locale"
  ansible.builtin.copy:
    dest: /etc/environment
    content: |
      LANG={{ locale_lang }}
      {% if locale_lc_all %}
      LC_ALL={{ locale_lc_all }}
      {% endif %}
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: locale_environment_config

- name: "STATE: Localed configuration must match target locale"
  ansible.builtin.command: localectl set-locale LANG={{ locale_lang }}
  register: locale_localed_set
  when:
    - locale_system_locale_config.changed or locale_environment_config.changed
    - not locale_is_container
  changed_when: locale_localed_set.rc == 0
  failed_when: false
  notify: Regenerate locales

- name: "VERIFY: Current locale configuration"
  ansible.builtin.command: localectl status
  register: locale_current_status
  changed_when: false
  failed_when: false
  when: not locale_is_container

- name: "VERIFY: Display current locale status"
  ansible.builtin.debug:
    msg: "{{ locale_current_status.stdout_lines | default(['Skipped: Running in container, no locale status available']) }}"
