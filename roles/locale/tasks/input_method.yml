---
# SPDX-License-Identifier: MIT-0
# =============================================================================
# Input Method Configuration
# =============================================================================
# STATE: Input method must be configured for English primary input
# Configures ibus or fcitx5 for consistent keyboard input
# =============================================================================

- name: "STATE: Input method package must be installed"
  ansible.builtin.package:
    name: "{{ locale_input_method }}"
    state: present

- name: "STATE: Ensure input method engine is installed"
  ansible.builtin.package:
    name: "{{ locale_input_method }}-engine"
    state: present
  register: locale_engine_install
  failed_when:
    - locale_engine_install is failed
    - "'No package' not in locale_engine_install.msg | default('')"
  when: locale_input_method == "ibus"

- name: "GATHER: Check current keyboard layouts"
  ansible.builtin.command: localectl list-x11-keymap-layouts
  register: locale_available_layouts
  changed_when: false

- name: "STATE: Configure keyboard layout via localectl"
  ansible.builtin.command: >
    localectl set-x11-keymap {{ locale_primary_keyboard_layout }}
  when: locale_remove_secondary_layouts
  changed_when: true

- name: "STATE: Configure GNOME input sources (user-level)"
  when: ansible_env.DISPLAY is defined
  block:
    - name: "GATHER: Check current GNOME input sources"
      ansible.builtin.command: >
        gsettings get org.gnome.desktop.input-sources sources
      register: locale_gnome_input_sources
      changed_when: false
      become: false
      failed_when: false

    - name: "STATE: Set GNOME input sources to English only"
      ansible.builtin.command: >
        gsettings set org.gnome.desktop.input-sources sources
        "[('xkb', '{{ locale_primary_keyboard_layout }}')]"
      when:
        - locale_remove_secondary_layouts
        - locale_gnome_input_sources.rc == 0
      changed_when: true
      become: false

    - name: "STATE: Set GNOME input sources with secondary layouts"
      ansible.builtin.shell: |
        sources="[('xkb', '{{ locale_primary_keyboard_layout }}')"
        {% for layout in locale_secondary_layouts %}
        sources="$sources, ('xkb', '{{ layout }}')"
        {% endfor %}
        sources="$sources]"
        gsettings set org.gnome.desktop.input-sources sources "$sources"
      when:
        - not locale_remove_secondary_layouts
        - locale_secondary_layouts | length > 0
        - locale_gnome_input_sources.rc == 0
      changed_when: true
      become: false

- name: "STATE: Configure ibus for English input"
  when: locale_input_method == "ibus"
  block:
    - name: "STATE: Create ibus configuration directory"
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.config/ibus"
        state: directory
        mode: "0755"
      become: false

    - name: "STATE: Create ibus bus directory"
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.config/ibus/bus"
        state: directory
        mode: "0755"
      become: false

    - name: "STATE: Create ibus registry file"
      ansible.builtin.copy:
        dest: "{{ ansible_env.HOME }}/.config/ibus/bus/registry"
        content: ""
        mode: "0644"
        force: false
      become: false
      register: locale_ibus_registry
      failed_when: false

- name: "VERIFY: Display current input configuration"
  ansible.builtin.command: localectl status
  register: locale_input_status
  changed_when: false

- name: "VERIFY: Show input configuration"
  ansible.builtin.debug:
    msg: "{{ locale_input_status.stdout_lines }}"
