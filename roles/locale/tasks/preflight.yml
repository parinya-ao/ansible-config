---
# SPDX-License-Identifier: MIT-0
# =============================================================================
# Pre-flight Validation & Locale Provisioning (Ensure Pattern)
# =============================================================================
# This task file implements the "Ensure" pattern:
# 1. Validates OS and format
# 2. ENSURES locale packages are installed
# 3. GENERATES locale if missing (instead of failing)
# 4. VALIDATES only after all above is done
# =============================================================================

- name: "PRE-FLIGHT: Locale Role Validation & Provisioning"
  tags:
    - locale
    - preflight
  block:
    - name: Ensure target OS is Fedora
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Fedora"
        fail_msg: |
          This role only supports Fedora!
          Detected: {{ ansible_distribution }}
        success_msg: "OS validated: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Validate locale_lang format
      ansible.builtin.assert:
        that:
          - locale_lang is match('^[a-z]{2}_[A-Z]{2}\.UTF-8$')
        fail_msg: |
          Invalid locale format: {{ locale_lang }}
          Expected format: ll_CC.UTF-8 (e.g., en_US.UTF-8)
        success_msg: "Locale format validated: {{ locale_lang }}"

    # =============================================================================
    # ENSURE: Locale Package Installation
    # =============================================================================
    # Extract language code from locale_lang (e.g., "en_US.UTF-8" -> "en")
    - name: Extract language code from locale
      ansible.builtin.set_fact:
        locale_lang_code: "{{ locale_lang.split('.')[0].split('_')[0] }}"

    - name: Ensure glibc-locale-source is installed (required for localedef in containers)
      ansible.builtin.dnf:
        name: glibc-locale-source
        state: present
      when: ansible_os_family == "RedHat"
      register: locale_locale_source_install

    - name: Ensure glibc-langpack for target locale is installed
      ansible.builtin.dnf:
        name: "glibc-langpack-{{ locale_lang_code }}"
        state: present
      when: ansible_os_family == "RedHat"
      register: locale_langpack_install

    - name: Ensure all English locale packs are available (fallback)
      ansible.builtin.dnf:
        name: glibc-langpack-en
        state: present
      when:
        - ansible_os_family == "RedHat"
        - locale_langpack_install is failed

    # =============================================================================
    # CHECK: Locale Availability (Case-Insensitive)
    # =============================================================================
    - name: Check if target locale is available
      ansible.builtin.command: locale -a
      register: locale_available_locales
      changed_when: false

    # Note: locale -a may return lowercase (en_US.utf8) or mixed case (en_US.UTF-8)
    # We normalize both to lowercase for comparison
    - name: Check if locale exists (case-insensitive)
      ansible.builtin.set_fact:
        locale_exists: "{{ locale_lang.lower() in locale_available_locales.stdout.lower() }}"

    # Normalize locale name to what the system actually has
    # If system has en_US.utf8, we should use that for verification
    - name: Determine actual locale name on system
      ansible.builtin.set_fact:
        locale_normalized: >-
          {{ (locale_available_locales.stdout.splitlines() |
             select('search', locale_lang.split('.')[0]) |
             first | default(locale_lang)).strip() }}
      when: locale_exists

    # =============================================================================
    # GENERATE: Create Missing Locale (Instead of Failing)
    # =============================================================================
    - name: Display locale availability status
      ansible.builtin.debug:
        msg: "Locale {{ locale_lang }} exists: {{ locale_exists }}"

    # Note: In minimal containers, localedef may fail due to missing charmap files
    # We use ignore_errors to continue if generation fails, since the locale
    # may still work if the langpack was installed successfully
    - name: Generate locale if missing using localedef
      ansible.builtin.command:
        cmd: localedef -c -i {{ locale_lang.split('.')[0] }} -f UTF-8 {{ locale_lang }}
      register: locale_generation
      when:
        - not locale_exists
      failed_when: false
      changed_when:
        - locale_generation is succeeded
        - locale_generation.rc == 0

    # Warn if locale generation failed (non-critical)
    - name: Warn if locale generation encountered issues
      ansible.builtin.debug:
        msg: |
          Warning: Locale generation encountered issues: {{ locale_generation.stderr | default('Unknown error') }}
          The locale may still work if glibc-langpack was installed.
      when:
        - not locale_exists
        - locale_generation is failed

    # Refresh locale list after generation attempt (for verification)
    - name: Refresh available locales after generation attempt
      ansible.builtin.command: locale -a
      register: locale_available_locales_final
      changed_when: false

    # Use normalized locale name for verification if it exists
    - name: Set final verification locale name
      ansible.builtin.set_fact:
        locale_verify_name: >-
          {{ ((locale_available_locales_final.stdout.splitlines() |
             select('search', locale_lang.split('.')[0]) |
             first | default(locale_lang)).strip()).lower() }}

    # Final verification that locale is available
    - name: Verify target locale is available
      ansible.builtin.assert:
        that:
          - locale_lang.lower() in locale_available_locales_final.stdout.lower()
        fail_msg: |
          Target locale {{ locale_lang }} is not available.
          Available locales with similar pattern:
          {{ locale_available_locales_final.stdout.splitlines() |
             select('search', locale_lang.split('.')[0]) |
             list | default(['None']) }}
          Please install glibc-langpack-{{ locale_lang_code }} manually.
        success_msg: "Locale {{ locale_lang }} is available (system reports: {{ locale_verify_name }})"

    # =============================================================================
    # PRE-FLIGHT COMPLETE
    # =============================================================================
    - name: Pre-flight validation complete
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Locale Role Pre-flight Checks PASSED"
          - "=========================================="
          - "Target Locale: {{ locale_lang }}"
          - "Input Method: {{ locale_input_method }}"
          - "Primary Layout: {{ locale_primary_keyboard_layout }}"
          - "Status: {{ 'Generated' if not locale_exists else 'Pre-existing' }}"
          - "=========================================="

  rescue:
    - name: Pre-flight validation failed
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Locale Role Pre-flight Checks FAILED"
          - "=========================================="
          - "Error: {{ ansible_failed_result.msg | default('Unknown error') }}"
          - "=========================================="

    - name: Fail the play with diagnostic information
      ansible.builtin.fail:
        msg: |
          Locale pre-flight validation failed. Please review the error above.
          Common issues:
          - Unsupported OS distribution (Fedora required)
          - Invalid locale format (expected: ll_CC.UTF-8)
          - Unable to install locale packages
          - Locale generation failed

  always:
    - name: Pre-flight cleanup
      ansible.builtin.debug:
        msg: "Locale pre-flight checks completed"
