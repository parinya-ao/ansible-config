---
# SPDX-License-Identifier: MIT-0
# =============================================================================
# CLI/TTY Language Enforcement
# =============================================================================
# STATE: All CLI/TTY sessions must use English locale
# Ensures consistent debugging and log output in English
# =============================================================================

- name: "STATE: System-wide locale profile must exist"
  ansible.builtin.copy:
    dest: /etc/profile.d/locale.sh
    content: |
      # SPDX-License-Identifier: MIT-0
      # Locale enforcement - generated by Ansible locale role
      # This file ensures CLI/TTY sessions use English locale

      export LANG="{{ locale_lang }}"
      {% if locale_lc_all %}
      export LC_ALL="{{ locale_lc_all }}"
      {% endif %}
      export LC_COLLATE="{{ locale_lc_collate }}"
    mode: "0644"
    owner: root
    group: root
    backup: true
  register: locale_profile_config

- name: "STATE: Ensure /etc/locale.conf is sourced by PAM"
  ansible.builtin.lineinfile:
    path: /etc/profile.d/locale.sh
    line: "test -f /etc/locale.conf && . /etc/locale.conf"
    state: present
    insertafter: EOF
    mode: "0644"

- name: "STATE: Configure bashrc locale for interactive shells"
  ansible.builtin.blockinfile:
    path: /etc/bashrc
    block: |
      # Locale enforcement for interactive shells
      export LANG="{{ locale_lang }}"
      {% if locale_lc_all %}
      export LC_ALL="{{ locale_lc_all }}"
      {% endif %}
    marker: "# {mark} ANSIBLE MANAGED LOCALE"
    insertafter: EOF
    state: present
    mode: "0644"
    backup: true
  register: locale_bashrc_config

- name: "STATE: Ensure fish config directory exists"
  ansible.builtin.file:
    path: /etc/fish
    state: directory
    mode: "0755"
  register: locale_fish_dir
  failed_when: false

- name: "STATE: Configure fish shell locale"
  ansible.builtin.blockinfile:
    path: /etc/fish/config.fish
    block: |
      # Locale enforcement for fish shell
      set -gx LANG {{ locale_lang }}
      {% if locale_lc_all %}
      set -gx LC_ALL {{ locale_lc_all }}
      {% endif %}
    marker: "# {mark} ANSIBLE MANAGED LOCALE"
    insertafter: EOF
    state: present
    mode: "0644"
    create: true
    backup: true
  register: locale_fish_config
  failed_when: false

- name: "STATE: Configure systemd user environment"
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.config/environment.d/locale.conf"
    content: |
      LANG={{ locale_lang }}
      {% if locale_lc_all %}
      LC_ALL={{ locale_lc_all }}
      {% endif %}
    mode: "0644"
    backup: true
  become: false

- name: "STATE: Ensure systemd user environment directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/environment.d"
    state: directory
    mode: "0755"
  become: false
  when: ansible_env.XDG_RUNTIME_DIR is defined

- name: "STATE: Update systemd user environment for current session"
  ansible.builtin.systemd:
    scope: user
    daemon_reload: false
  become: false
  register: locale_systemd_reload
  failed_when: false
  changed_when: false
  when:
    - ansible_env.XDG_RUNTIME_DIR is defined
    - not (ansible_env.CI is defined or ansible_env.GITHUB_ACTIONS is defined)

- name: "VERIFY: Display current locale environment"
  ansible.builtin.command: locale
  register: locale_current_env
  changed_when: false
  failed_when: false
  become: false

- name: "VERIFY: Show current locale environment"
  ansible.builtin.debug:
    msg: "{{ locale_current_env.stdout_lines | default(['Failed: Unable to retrieve current locale environment']) }}"

- name: "INFO: CLI language enforcement complete"
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "CLI Language Enforcement Applied"
      - "=========================================="
      - "Note: Some changes require relogin to take effect:"
      - "  - /etc/profile.d/locale.sh"
      - "  - /etc/bashrc"
      - "  - fish config (if installed)"
      - "=========================================="
