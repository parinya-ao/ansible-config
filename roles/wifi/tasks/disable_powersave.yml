---
- name: Check if iwlwifi module is loaded
  ansible.builtin.command: lsmod
  register: wifi_lsmod_out
  changed_when: false

- name: Skip host if no Intel Wi-Fi
  ansible.builtin.meta: end_play
  when: "'iwlwifi' not in wifi_lsmod_out.stdout"

- name: Disable Wi-Fi power save via NetworkManager
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/20-wifi-powersave.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      [connection]
      wifi.powersave=2
  notify: Restart NetworkManager

- name: Disable iwlwifi firmware power save
  ansible.builtin.copy:
    dest: /etc/modprobe.d/iwlwifi-powersave.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      options iwlwifi power_level=0

- name: Ensure kernel param iwlwifi.power_save=0
  ansible.builtin.command: grubby --update-kernel=ALL --args="iwlwifi.power_save=0"
  register: wifi_grub_out
  changed_when: false
  failed_when: false
