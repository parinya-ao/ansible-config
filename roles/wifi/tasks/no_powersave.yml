---
- name: Skip Wi-Fi configuration in CI environment
  ansible.builtin.meta: end_host
  when: ansible_env.CI is defined and ansible_env.CI | bool

- name: Detect Wi-Fi interfaces
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      iw dev | awk '/Interface/ {print $2}'
  args:
    executable: /bin/bash
  register: wifi_ifaces
  changed_when: false
  failed_when: false

- name: Stop if no Wi-Fi interface found
  ansible.builtin.meta: end_play
  when: wifi_ifaces.stdout_lines | length == 0

- name: Disable Wi-Fi power save in NetworkManager
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/20-wifi-powersave.conf
    mode: "0644"
    content: |
      [connection]
      wifi.powersave=2
  notify: Restart NetworkManager

- name: Disable MAC randomization globally
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/30-wifi-mac.conf
    mode: "0644"
    content: |
      [device]
      wifi.scan-rand-mac-address=no

      [connection]
      wifi.cloned-mac-address=permanent
  notify: Restart NetworkManager

- name: Build iwlwifi modprobe configuration
  ansible.builtin.set_fact:
    wifi_iwlwifi_config: |
      # Power management - disable all for maximum stability
      options iwlwifi power_level=0
      options iwlwifi power_save=0
      {% if wifi_iwlwifi_uapsd_disable %}options iwlwifi uapsd_disable=1{% endif %}
      {% if wifi_iwlwifi_d0i3_disable %}options iwlwifi d0i3_disable=1{% endif %}

      # Bluetooth coexistence - enable for BT devices, disable for Wi-Fi only
      {% if wifi_iwlwifi_bt_coex_active %}options iwlwifi bt_coex_active=1{% else %}options iwlwifi bt_coex_active=0{% endif %}
      {% if wifi_iwlwifi_scan_ant_prio_enable %}options iwlwifi scan_ant_prio=1{% endif %}

      # CPU optimization - use hardware encryption
      options iwlwifi swcrypto={{ wifi_iwlwifi_swcrypto }}

      # Stability options
      {% if wifi_iwlwifi_11n_disable %}options iwlwifi 11n_disable={{ wifi_iwlwifi_11n_disable_value }}{% endif %}
      options iwlwifi disable_11ax=1

- name: Disable iwlwifi firmware power saving
  ansible.builtin.copy:
    dest: /etc/modprobe.d/iwlwifi-stability.conf
    mode: "0644"
    content: "{{ wifi_iwlwifi_config | trim }}"

- name: Check current kernel args
  ansible.builtin.command: grubby --info=DEFAULT
  register: wifi_grubby_info
  changed_when: false
  failed_when: false

- name: Disable kernel iwlwifi power save parameter
  ansible.builtin.command: grubby --update-kernel=ALL --args="iwlwifi.power_save=0"
  when: "'iwlwifi.power_save=0' not in wifi_grubby_info.stdout"
  changed_when: false

- name: Check current power save status
  ansible.builtin.shell:
    cmd: |
      for iface in {{ wifi_ifaces.stdout_lines | join(' ') }}; do
        iw dev "$iface" get power_save
      done
  args:
    executable: /bin/bash
  register: wifi_current_power_save
  changed_when: false

- name: Check if any interface has power save enabled
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      for iface in {{ wifi_ifaces.stdout_lines | join(' ') }}; do
        iw dev "$iface" get power_save | grep -q "on" && echo "found"
      done
  args:
    executable: /bin/bash
  register: wifi_power_save_on
  changed_when: false
  failed_when: false

- name: Force power_save off on all Wi-Fi interfaces
  ansible.builtin.shell:
    cmd: |
      for iface in {{ wifi_ifaces.stdout_lines | join(' ') }}; do
        iw dev "$iface" set power_save off
      done
  args:
    executable: /bin/bash
  when: wifi_power_save_on.stdout | length > 0
  changed_when: false

- name: Configure network stack for reduced CPU overhead
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-network-stability.conf
    mode: "0644"
    content: |
      # SPDX-License-Identifier: MIT-0
      # Network stack tuning for reduced CPU overhead and improved stability
      # Increase buffer sizes to reduce interrupt frequency
      net.core.rmem_max = 16777216
      net.core.wmem_max = 16777216
      net.ipv4.tcp_rmem = 4096 87380 16777216
      net.ipv4.tcp_wmem = 4096 65536 16777216
  when: wifi_enable_network_tuning
  notify: Apply sysctl settings

- name: Configure Bluetooth latency optimization
  ansible.builtin.copy:
    dest: /etc/sysctl.d/98-bluetooth-latency.conf
    mode: "0644"
    content: |
      # SPDX-License-Identifier: MIT-0
      # Bluetooth latency optimization for multiple BT devices
      # Increases netdev_max_backlog to reduce Bluetooth input queue delay
      # Helps prevent mouse/keyboard/audio stuttering when used with Wi-Fi
      net.core.netdev_max_backlog = 5000
  when: wifi_enable_bluetooth_optimization
  notify: Apply sysctl settings

- name: Disable USB autosuspend for stable USB tethering
  ansible.builtin.copy:
    dest: /etc/tmpfiles.d/usb-autosuspend.conf
    mode: "0644"
    content: |
      # SPDX-License-Identifier: MIT-0
      # Disable USB autosuspend for stable tethering
      # Write to /sys/module/usbcore/parameters/autosuspend
      w /sys/module/usbcore/parameters/autosuspend - - - - -1
  when: wifi_disable_usb_autosuspend

- name: Ensure irqbalance is installed for interrupt distribution
  ansible.builtin.package:
    name: irqbalance
    state: present
  when: wifi_enable_network_tuning

- name: Enable and start irqbalance service
  ansible.builtin.service:
    name: irqbalance
    state: started
    enabled: true
  when: wifi_enable_network_tuning
