---
# SPDX-License-Identifier: MIT-0
# tasks file for roles/git
# Configures git globally with optional SSH signing if key exists

# ============================================================================
# Git Identity Configuration
# ============================================================================

- name: Set git user.name
  community.general.git_config:
    name: user.name
    value: "{{ git_config_name }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

- name: Set git user.email
  community.general.git_config:
    name: user.email
    value: "{{ git_config_email }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Commit Configuration
# ============================================================================

- name: Set commit.verbose
  community.general.git_config:
    name: commit.verbose
    value: "{{ git_commit_verbose }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Push and Pull Configuration
# ============================================================================

- name: Enable auto-setup remote on push
  community.general.git_config:
    name: push.autosetupremote
    value: "{{ git_push_autosetupremote }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

- name: Set pull.rebase
  community.general.git_config:
    name: pull.rebase
    value: "{{ git_pull_rebase }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Rebase Configuration
# ============================================================================

- name: Set rebase.autostash
  community.general.git_config:
    name: rebase.autostash
    value: "{{ git_rebase_autostash }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Fetch Configuration
# ============================================================================

- name: Set fetch.prune
  community.general.git_config:
    name: fetch.prune
    value: "{{ git_fetch_prune }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Rerere Configuration
# ============================================================================

- name: Enable rerere
  community.general.git_config:
    name: rerere.enabled
    value: "{{ git_rerere_enabled }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

- name: Enable rerere autoupdate
  community.general.git_config:
    name: rerere.autoupdate
    value: "{{ git_rerere_autoupdate }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Core Configuration
# ============================================================================

- name: Set core.autocrlf
  community.general.git_config:
    name: core.autocrlf
    value: "{{ git_core_autocrlf }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

- name: Set core.editor
  community.general.git_config:
    name: core.editor
    value: "{{ git_core_editor }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# Git Aliases
# ============================================================================

- name: Set alias.lg
  community.general.git_config:
    name: alias.lg
    value: "{{ git_alias_lg }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ actual_user_name }}"

# ============================================================================
# SSH Signing Configuration
# ============================================================================

- name: Check if SSH public key exists
  ansible.builtin.stat:
    path: "{{ actual_user_home }}/.ssh/id_ed25519.pub"
  register: ssh_public_key
  become: true
  become_user: "{{ actual_user_name }}"

- name: Configure git SSH signing
  become: true
  become_user: "{{ actual_user_name }}"
  when: ssh_public_key.stat.exists
  block:
    - name: Read SSH public key content
      ansible.builtin.slurp:
        path: "{{ actual_user_home }}/.ssh/id_ed25519.pub"
      register: ssh_pubkey_content

    - name: Create allowed_signers file
      ansible.builtin.copy:
        content: "{{ git_config_email }} namespaces=\"git\" {{ ssh_pubkey_content.content | b64decode | trim }}\n"
        dest: "{{ actual_user_home }}/.ssh/allowed_signers"
        mode: "0644"
        owner: "{{ actual_user_name }}"
        group: "{{ actual_user_name }}"

    - name: Set git signing key to SSH public key
      community.general.git_config:
        name: user.signingkey
        value: "{{ actual_user_home }}/.ssh/id_ed25519.pub"
        scope: "{{ git_config_scope }}"

    - name: Use SSH format for git signing
      community.general.git_config:
        name: gpg.format
        value: ssh
        scope: "{{ git_config_scope }}"

    - name: Set allowed signers file
      community.general.git_config:
        name: gpg.ssh.allowedSignersFile
        value: "{{ actual_user_home }}/.ssh/allowed_signers"
        scope: "{{ git_config_scope }}"

    - name: Enable commit signing
      community.general.git_config:
        name: commit.gpgsign
        value: "{{ git_commit_gpgsign }}"
        scope: "{{ git_config_scope }}"
