---
# SPDX-License-Identifier: MIT-0
# tasks file for roles/git
# Configures git globally with optional SSH signing if key exists

- name: Check if SSH public key exists
  stat:
    path: "{{ git_ssh_pubkey_path }}"
  register: ssh_pubkey_stat
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Git Identity Configuration
# ============================================================================

- name: Set git user.name
  community.general.git_config:
    name: user.name
    value: "{{ git_config_name }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

- name: Set git user.email
  community.general.git_config:
    name: user.email
    value: "{{ git_config_email }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Commit Configuration
# ============================================================================

- name: Set commit.verbose
  community.general.git_config:
    name: commit.verbose
    value: "{{ git_commit_verbose }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Push and Pull Configuration
# ============================================================================

- name: Enable auto-setup remote on push
  community.general.git_config:
    name: push.autosetupremote
    value: "{{ git_push_autosetupremote }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

- name: Set pull.rebase
  community.general.git_config:
    name: pull.rebase
    value: "{{ git_pull_rebase }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Rebase Configuration
# ============================================================================

- name: Set rebase.autostash
  community.general.git_config:
    name: rebase.autostash
    value: "{{ git_rebase_autostash }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Fetch Configuration
# ============================================================================

- name: Set fetch.prune
  community.general.git_config:
    name: fetch.prune
    value: "{{ git_fetch_prune }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Rerere Configuration
# ============================================================================

- name: Enable rerere
  community.general.git_config:
    name: rerere.enabled
    value: "{{ git_rerere_enabled }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

- name: Enable rerere autoupdate
  community.general.git_config:
    name: rerere.autoupdate
    value: "{{ git_rerere_autoupdate }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Core Configuration
# ============================================================================

- name: Set core.autocrlf
  community.general.git_config:
    name: core.autocrlf
    value: "{{ git_core_autocrlf }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

- name: Set core.editor
  community.general.git_config:
    name: core.editor
    value: "{{ git_core_editor }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# Git Aliases
# ============================================================================

- name: Set alias.lg
  community.general.git_config:
    name: alias.lg
    value: "{{ git_alias_lg }}"
    scope: "{{ git_config_scope }}"
  become: true
  become_user: "{{ git_config_user }}"

# ============================================================================
# SSH Signing Configuration (Conditional)
# ============================================================================

- name: Configure git SSH signing (if SSH key exists)
  when: ssh_pubkey_stat.stat.exists
  become: true
  become_user: "{{ git_config_user }}"
  block:
    - name: Set git signing key to SSH public key
      community.general.git_config:
        name: user.signingkey
        value: "{{ git_ssh_pubkey_path }}"
        scope: "{{ git_config_scope }}"

    - name: Use SSH format for git signing
      community.general.git_config:
        name: gpg.format
        value: ssh
        scope: "{{ git_config_scope }}"

    - name: Enable commit signing
      community.general.git_config:
        name: commit.gpgsign
        value: "{{ git_commit_gpgsign }}"
        scope: "{{ git_config_scope }}"
