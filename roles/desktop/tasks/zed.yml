# SPDX-License-Identifier: MIT-0
---
# Install Zed editor

- name: Check if Zed is already installed
  ansible.builtin.stat:
    path: "{{ desktop_target_home }}/.local/bin/zed"
  register: desktop_zed_binary
  become: true
  become_user: "{{ desktop_target_user }}"

- name: Download Zed tarball
  ansible.builtin.get_url:
    url: "{{ desktop_zed_download_url }}"
    dest: /tmp/zed-linux-x86_64.tar.gz
    mode: "0644"
  when: not desktop_zed_binary.stat.exists

- name: Ensure .local directory exists
  ansible.builtin.file:
    path: "{{ desktop_target_home }}/.local"
    state: directory
    mode: "0755"
    owner: "{{ desktop_target_user }}"

- name: Extract Zed to .local
  ansible.builtin.unarchive:
    src: /tmp/zed-linux-x86_64.tar.gz
    dest: "{{ desktop_target_home }}/.local"
    mode: "0755"
    remote_src: true
    owner: "{{ desktop_target_user }}"
  when: not desktop_zed_binary.stat.exists

- name: Ensure .local/bin directory exists
  ansible.builtin.file:
    path: "{{ desktop_target_home }}/.local/bin"
    state: directory
    mode: "0755"
    owner: "{{ desktop_target_user }}"

- name: Create symlink for Zed binary
  ansible.builtin.file:
    src: "{{ desktop_target_home }}/.local/zed.app/bin/zed"
    dest: "{{ desktop_target_home }}/.local/bin/zed"
    state: link
    owner: "{{ desktop_target_user }}"
  when: not desktop_zed_binary.stat.exists

- name: Ensure .local/share/applications directory exists
  ansible.builtin.file:
    path: "{{ desktop_target_home }}/.local/share/applications"
    state: directory
    mode: "0755"
    owner: "{{ desktop_target_user }}"

- name: Install Zed desktop entry
  ansible.builtin.copy:
    src: "{{ desktop_target_home }}/.local/zed.app/share/applications/zed.desktop"
    dest: "{{ desktop_target_home }}/.local/share/applications/dev.zed.Zed.desktop"
    mode: "0644"
    remote_src: true
    owner: "{{ desktop_target_user }}"
  when: not desktop_zed_binary.stat.exists

- name: Update desktop entry icon path
  ansible.builtin.lineinfile:
    path: "{{ desktop_target_home }}/.local/share/applications/dev.zed.Zed.desktop"
    regexp: "^Icon=zed$"
    line: >-
      Icon={{ desktop_target_home }}/.local/zed.app/share/icons/hicolor/512x512/apps/zed.png
    backrefs: true
  when: not desktop_zed_binary.stat.exists

- name: Update desktop entry exec path
  ansible.builtin.lineinfile:
    path: "{{ desktop_target_home }}/.local/share/applications/dev.zed.Zed.desktop"
    regexp: "^Exec=zed$"
    line: "Exec={{ desktop_target_home }}/.local/zed.app/libexec/zed-editor"
    backrefs: true
  when: not desktop_zed_binary.stat.exists

- name: Clean up downloaded tarball
  ansible.builtin.file:
    path: /tmp/zed-linux-x86_64.tar.gz
    state: absent
  when: not desktop_zed_binary.stat.exists

- name: Display Zed installation complete
  ansible.builtin.debug:
    msg: "Zed editor installed successfully."
