# SPDX-License-Identifier: MIT-0
---
- name: Get Typst release metadata from GitHub
  ansible.builtin.uri:
    url: >-
      https://api.github.com/repos/typst/typst/releases/{{
      'latest' if desktop_typst_version == 'latest'
      else 'tags/v' + desktop_typst_version
      }}
    return_content: true
  register: desktop_typst_api
  when: desktop_install_typst | bool

- name: Set Typst download URL
  ansible.builtin.set_fact:
    desktop_typst_download_url: >-
      {{
      (desktop_typst_api.json.assets
      | selectattr('name', 'search', 'x86_64-unknown-linux-musl.tar.gz')
      | first).browser_download_url
      }}
  when: desktop_install_typst | bool

- name: Download and Install Typst Binary
  ansible.builtin.unarchive:
    src: "{{ desktop_typst_download_url }}"
    dest: /usr/local/bin
    remote_src: true
    extra_opts:
      - "--strip-components=1"
      - "--wildcards"
      - "*/typst"
    owner: root
    group: root
    mode: "0755"
  when: desktop_install_typst | bool

- name: Verify Typst Installation
  ansible.builtin.command: typst --version
  register: desktop_typst_check
  changed_when: false
  when: desktop_install_typst | bool

- name: Show Typst Version
  ansible.builtin.debug:
    msg: "Typst installed successfully: {{ desktop_typst_check.stdout }}"
  when: desktop_install_typst | bool
