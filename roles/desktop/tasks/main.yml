# SPDX-License-Identifier: MIT-0
---
# tasks file for roles/desktop

# Resolve the real (non-root) user and home directory.
# When the playbook runs with become: true, ansible_facts['user_dir'] and
# ansible_facts['user_id'] resolve to root. We need the actual invoking user
# so that per-user tools (Zed, etc.) are installed into the correct home directory.
- name: Determine the real (non-root) target user
  ansible.builtin.set_fact:
    desktop_target_user: "{{ ansible_env.SUDO_USER | default(ansible_facts['user_id']) }}"
  tags:
    - always

- name: Look up target user passwd entry
  ansible.builtin.getent:
    database: passwd
    key: "{{ desktop_target_user }}"
  tags:
    - always

- name: Set target user home directory
  ansible.builtin.set_fact:
    desktop_target_home: "{{ ansible_facts.getent_passwd[desktop_target_user][4] }}"
  tags:
    - always

- name: Install desktop packages
  ansible.builtin.import_tasks: packages.yml
  tags:
    - desktop
    - packages

- name: Install GNOME extensions
  ansible.builtin.import_tasks: gnome-extensions.yml
  tags:
    - desktop
    - gnome

- name: Install Starship prompt
  ansible.builtin.import_tasks: starship.yml
  tags:
    - desktop
    - starship

- name: Install Flatpak applications
  ansible.builtin.import_tasks: flatpak-apps.yml
  tags:
    - desktop
    - flatpak

- name: Configure Flatpak font access
  ansible.builtin.import_tasks: flatpak-fonts.yml
  tags:
    - desktop
    - flatpak
    - fonts

- name: Install Typst
  ansible.builtin.import_tasks: typst.yml
  tags:
    - desktop
    - typst

- name: Install Ghostty terminal
  ansible.builtin.import_tasks: ghostty.yml
  when: desktop_install_ghostty
  tags:
    - desktop
    - ghostty
    - terminal

- name: Configure GNOME default applications
  ansible.builtin.import_tasks: gnome-defaults.yml
  tags:
    - desktop
    - gnome
    - defaults

- name: Install Firefox ESR
  ansible.builtin.import_tasks: firefox-esr.yml
  when: desktop_install_firefox_esr
  tags:
    - desktop
    - firefox
    - browser
