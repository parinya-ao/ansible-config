---
# SPDX-License-Identifier: MIT-0
# tasks file for roles/multimedia

- name: Install multimedia codec packages
  ansible.builtin.dnf:
    name: "@multimedia"
    state: present
  when: multimedia_install_codecs | bool
  become: true
  tags:
    - multimedia
    - codecs

- name: Swap to full FFMPEG (remove conflicting free packages)
  ansible.builtin.dnf:
    name: "ffmpeg"
    state: present
    allowerasing: true
  when: multimedia_install_codecs | bool
  become: true
  tags:
    - multimedia
    - codecs

- name: Install FFMPEG and related packages
  ansible.builtin.dnf:
    name: "{{ multimedia_codec_packages }}"
    state: present
    allowerasing: true
  when: multimedia_install_codecs | bool
  become: true
  tags:
    - multimedia
    - codecs

- name: Install sound and video complementary packages
  ansible.builtin.dnf:
    name: "@sound-and-video"
    state: present
  when: multimedia_install_codecs | bool
  become: true
  tags:
    - multimedia
    - codecs

- name: Install hardware video acceleration base packages
  ansible.builtin.dnf:
    name:
      - ffmpeg-libs
      - libva
      - libva-utils
    state: present
  when: multimedia_install_video_acceleration | bool
  become: true
  tags:
    - multimedia
    - video-acceleration

- name: Install Intel video acceleration drivers
  ansible.builtin.dnf:
    name: "{{ multimedia_intel_packages }}"
    state: present
  when:
    - multimedia_install_video_acceleration | bool
    - multimedia_gpu_vendor == "intel"
  become: true
  tags:
    - multimedia
    - video-acceleration
    - intel

- name: Install AMD video acceleration drivers
  ansible.builtin.dnf:
    name: "{{ multimedia_amd_packages }}"
    state: present
    allowerasing: true
  when:
    - multimedia_install_video_acceleration | bool
    - multimedia_gpu_vendor == "amd"
  become: true
  tags:
    - multimedia
    - video-acceleration
    - amd

- name: Install OpenH264 packages
  ansible.builtin.dnf:
    name: "{{ multimedia_openh264_packages }}"
    state: present
  when: multimedia_install_openh264 | bool
  become: true
  tags:
    - multimedia
    - openh264

- name: Check Cisco OpenH264 repository status
  ansible.builtin.shell: |
    set -o pipefail
    dnf repolist enabled 2>/dev/null | grep -q "fedora-cisco-openh264" || \
    dnf config-manager repo-fedora-cisco-openh264 2>/dev/null | grep -q "enabled = 1" || \
    grep -q "^enabled=1" /etc/yum.repos.d/fedora-cisco-openh264.repo 2>/dev/null && echo "enabled" || echo "disabled"
  register: multimedia_openh264_status
  changed_when: false
  failed_when: false
  when: multimedia_install_openh264 | bool
  become: true
  tags:
    - multimedia
    - openh264

- name: Enable Cisco OpenH264 repository
  ansible.builtin.command: dnf config-manager setopt fedora-cisco-openh264.enabled=1
  when:
    - multimedia_install_openh264 | bool
    - multimedia_openh264_status.stdout is defined
    - multimedia_openh264_status.stdout != "enabled"
  become: true
  changed_when: false
  tags:
    - multimedia
    - openh264
