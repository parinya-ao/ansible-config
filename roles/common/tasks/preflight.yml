---
# SPDX-License-Identifier: MIT-0
# =============================================================================
# Pre-flight Validation Tasks
# =============================================================================
# Replaces shell-based checks from command/lib/domain/system_checks.sh
# and command/lib/domain/dnf_checks.sh
# =============================================================================

- name: "PRE-FLIGHT: System Validation"
  tags:
    - common
    - preflight
  block:
    - name: Ensure target OS is Fedora
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Fedora"
        fail_msg: |
          This playbook only supports Fedora!
          Detected: {{ ansible_distribution }}
        success_msg: "OS validated: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Check minimum RAM
      ansible.builtin.assert:
        that:
          - ansible_memtotal_mb >= 2048
        fail_msg: |
          Insufficient RAM. Required: 2048MB, Available: {{ ansible_memtotal_mb }}MB
        success_msg: "RAM validated: {{ ansible_memtotal_mb }}MB available"

    - name: Check minimum disk space
      ansible.builtin.assert:
        that:
          - (ansible_mounts | selectattr('mount', 'equalto', '/') | first).size_available | default(0) | int >= 1073741824
        fail_msg: |
          Insufficient disk space. Required: 1GB available
        success_msg: "Disk space validated"

    - name: Check for DNF lock (wait up to 30 seconds)
      ansible.builtin.wait_for:
        path: /var/cache/dnf/metadata_lock.pid
        state: absent
        timeout: 30
        msg: "DNF is locked by another process. Please close Software Center or other package managers."
      ignore_errors: true
      register: common_dnf_lock_check

    - name: Warn if DNF was locked (continue anyway)
      ansible.builtin.debug:
        msg: "Warning: DNF lock detected but continuing. Package operations may fail."
      when: common_dnf_lock_check is failed

    - name: Pre-flight validation complete
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Pre-flight checks PASSED"
          - "=========================================="
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "RAM: {{ ansible_memtotal_mb }}MB"
          - "Arch: {{ ansible_architecture }}"
          - "=========================================="
