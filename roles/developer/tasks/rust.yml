---
# SPDX-License-Identifier: MIT-0
# Rust toolchain installation via rustup

- name: Check if Rust is already installed
  ansible.builtin.command:
    cmd: command -v rustc
  register: developer_rust_installed
  changed_when: false
  ignore_errors: true
  become: false
  tags:
    - rust
    - compilers

- name: Download rustup installer
  ansible.builtin.get_url:
    url: "{{ developer_rustup_install_url }}"
    dest: /tmp/install-rustup.sh
    mode: "0755"
  when: developer_rust_installed.rc != 0
  become: false
  tags:
    - rust
    - compilers

- name: Install Rust toolchain via rustup
  ansible.builtin.command:
    cmd: /tmp/install-rustup.sh -y
  args:
    creates: "{{ lookup('env', 'HOME') }}/.cargo/bin/rustc"
  become: false
  tags:
    - rust
    - compilers

- name: Clean up rustup installer script
  ansible.builtin.file:
    path: /tmp/install-rustup.sh
    state: absent
  when: developer_rust_installed.rc != 0
  tags:
    - rust
    - compilers

- name: Verify Rust installation
  ansible.builtin.command:
    cmd: "{{ lookup('env', 'HOME') }}/.cargo/bin/rustc --version"
  register: developer_rust_version
  changed_when: false
  become: false
  tags:
    - rust
    - compilers

- name: Display Rust version
  ansible.builtin.debug:
    msg: "{{ developer_rust_version.stdout }}"
  when: developer_rust_version.stdout is defined
  tags:
    - rust
    - compilers
