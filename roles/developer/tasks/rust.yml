---
# SPDX-License-Identifier: MIT-0
# Rust toolchain installation via rustup

- name: Check if Rust binary exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.cargo/bin/rustc"
  register: developer_rust_check
  become: false
  tags:
    - rust
    - compilers

- name: Download rustup installer
  ansible.builtin.get_url:
    url: "{{ developer_rustup_install_url }}"
    dest: /tmp/install-rustup.sh
    mode: "0755"
  when: not developer_rust_check.stat.exists
  become: false
  tags:
    - rust
    - compilers

- name: Install Rust toolchain via rustup
  ansible.builtin.command:
    cmd: /tmp/install-rustup.sh -y
  args:
    creates: "{{ lookup('env', 'HOME') }}/.cargo/bin/rustc"
  become: false
  tags:
    - rust
    - compilers

- name: Clean up rustup installer script
  ansible.builtin.file:
    path: /tmp/install-rustup.sh
    state: absent
  when: not developer_rust_check.stat.exists
  tags:
    - rust
    - compilers

- name: Verify Rust installation
  ansible.builtin.command:
    cmd: "{{ lookup('env', 'HOME') }}/.cargo/bin/rustc --version"
  register: developer_rust_version
  changed_when: false
  become: false
  tags:
    - rust
    - compilers

- name: Display Rust version
  ansible.builtin.debug:
    msg: "{{ developer_rust_version.stdout }}"
  when: developer_rust_version.stdout is defined
  tags:
    - rust
    - compilers
