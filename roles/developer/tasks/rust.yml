---
# SPDX-License-Identifier: MIT-0
# Rust toolchain installation via rustup

- name: Check if Rust binary exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.cargo/bin/rustc"
  register: developer_rust_check
  become: false
  tags:
    - rust
    - compilers

- name: Download rustup installer
  ansible.builtin.get_url:
    url: "{{ developer_rustup_install_url }}"
    dest: /tmp/install-rustup.sh
    mode: "0755"
  when: not developer_rust_check.stat.exists
  become: false
  tags:
    - rust
    - compilers

- name: Install Rust toolchain via rustup
  ansible.builtin.shell: |
    # Force set environment variables for correct installation path
    export CARGO_HOME="{{ ansible_facts['user_dir'] }}/.cargo"
    export RUSTUP_HOME="{{ ansible_facts['user_dir'] }}/.rustup"

    # Run installer with default stable toolchain to ensure compiler is installed
    sh /tmp/install-rustup.sh -y --default-toolchain stable
  args:
    creates: "{{ ansible_facts['user_dir'] }}/.cargo/bin/rustc"
  become: false
  tags:
    - rust
    - compilers

- name: Clean up rustup installer script
  ansible.builtin.file:
    path: /tmp/install-rustup.sh
    state: absent
  when: not developer_rust_check.stat.exists
  tags:
    - rust
    - compilers

- name: Verify Rust installation
  ansible.builtin.command:
    cmd: "{{ ansible_facts['user_dir'] }}/.cargo/bin/rustc --version"
  register: developer_rust_version
  changed_when: false
  become: false
  tags:
    - rust
    - compilers

- name: Display Rust version
  ansible.builtin.debug:
    msg: "{{ developer_rust_version.stdout }}"
  when: developer_rust_version.stdout is defined
  tags:
    - rust
    - compilers
