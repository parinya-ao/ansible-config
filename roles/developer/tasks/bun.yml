---
# SPDX-License-Identifier: MIT-0
# Bun JavaScript runtime installation

- name: Check if Bun binary exists
  ansible.builtin.stat:
    path: "{{ developer_target_home }}/.bun/bin/bun"
  register: developer_bun_check
  become: false
  tags:
    - bun
    - javascript

- name: Download Bun installer script
  ansible.builtin.get_url:
    url: "{{ developer_bun_install_url }}"
    dest: /tmp/install-bun.sh
    mode: "0755"
  when: not developer_bun_check.stat.exists
  become: false
  tags:
    - bun
    - javascript

- name: Execute Bun installer
  ansible.builtin.shell:
    cmd: |
      export BUN_INSTALL="{{ developer_target_home }}/.bun"
      bash /tmp/install-bun.sh
  args:
    creates: "{{ developer_target_home }}/.bun/bin/bun"
    executable: /bin/bash
  when: not developer_bun_check.stat.exists
  become: true
  become_user: "{{ developer_target_user }}"
  tags:
    - bun
    - javascript

- name: Clean up installer script
  ansible.builtin.file:
    path: /tmp/install-bun.sh
    state: absent
  when: not developer_bun_check.stat.exists
  tags:
    - bun
    - javascript

- name: Verify Bun installation
  ansible.builtin.command:
    cmd: "{{ developer_target_home }}/.bun/bin/bun --version"
  register: developer_bun_version
  changed_when: false
  become: true
  become_user: "{{ developer_target_user }}"
  tags:
    - bun
    - javascript

- name: Display Bun version
  ansible.builtin.debug:
    msg: "Bun {{ developer_bun_version.stdout }} installed"
  when: developer_bun_version.stdout is defined
  tags:
    - bun
    - javascript
