---
# SPDX-License-Identifier: MIT-0
# Developer role - Main entry point
# This role installs a complete development environment including:
# - System compilers and development tools (includes Rust via dnf)
# - Bun JavaScript runtime
# - uv Python package manager

# Resolve the real (non-root) user and home directory.
# When the playbook runs with become: true, ansible_facts['user_dir'] and
# ansible_facts['user_id'] resolve to root. We need the actual invoking user
# so that per-user tools (Bun, uv, Flutter, Android SDK) are installed into
# the correct home directory.
- name: Determine the real (non-root) target user
  ansible.builtin.set_fact:
    developer_target_user: "{{ ansible_env.SUDO_USER | default(ansible_facts['user_id']) }}"
  tags:
    - always

- name: Look up target user passwd entry
  ansible.builtin.getent:
    database: passwd
    key: "{{ developer_target_user }}"
  tags:
    - always

- name: Set target user home directory
  ansible.builtin.set_fact:
    developer_target_home: "{{ ansible_facts.getent_passwd[developer_target_user][4] }}"
  tags:
    - always

- name: Display resolved target user info
  ansible.builtin.debug:
    msg:
      - "Target user: {{ developer_target_user }}"
      - "Target home: {{ developer_target_home }}"
  tags:
    - always

# Compilers & CLI Tools
- name: Install compilers and CLI tools
  ansible.builtin.import_tasks: compilers.yml
  tags:
    - developers
    - compilers

# Neovim configuration
- name: Configure Neovim with LazyVim
  ansible.builtin.import_tasks: neovim.yml
  when: developer_install_lazyvim
  tags:
    - developers
    - neovim

# Bun runtime
- name: Install Bun
  ansible.builtin.import_tasks: bun.yml
  when: developer_install_bun
  tags:
    - developers
    - bun

# Python tooling
- name: Install Python tooling
  ansible.builtin.import_tasks: python.yml
  when: developer_install_uv
  tags:
    - developers
    - python

# Flutter SDK
- name: Install Flutter SDK
  ansible.builtin.import_tasks: flutter.yml
  when: developer_install_flutter
  tags:
    - developers
    - flutter

# Android SDK
- name: Install Android SDK
  ansible.builtin.import_tasks: android-sdk.yml
  when: developer_install_android_sdk
  tags:
    - developers
    - android
